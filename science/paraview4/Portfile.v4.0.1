PortSystem	1.0
# Our cmake settings differ, no use for the portgroup cmake
#PortGroup	cmake 1.0
PortGroup       qt4 1.0

categories	graphics,science
name		paraview
version		4.0.1

description	data analysis and visualization application
long_description	\
		ParaView is an open-source, multi-platform data analysis and \
		visualization application. ParaView users can quickly build \
		visualizations to analyze their data using qualitative and \
		quantitative techniques. The data exploration can be done \
		interactively in 3D or programmatically using ParaViewâ€™s \
		batch processing capabilities.
homepage	http://paraview.org
master_sites	http://www.paraview.org/paraview-downloads/download.php?submit=Download&version=v4.0&type=source&os=all&downloadFile=
maintainers	nomaintainer
distname	ParaView-v${version}-source
extract.suffix	.tgz
checksums	ParaView-v4.0.1-source.tgz \
    md5 6a300744eaf32676a3a7e1b42eb642c7 \
    sha1 098b80f3220e824e6bddee92ca7f731f9f2cb7c8 \
    rmd160 4c0b5f5e10aa6b2e498780f0342012866b227b10 \
    sha224 acf6cb22ea7be873ecc590d419f6774cc3b7dc25b7592930dc4399d7 \
    sha256 1e04fcc085ee0305a163d9b6a66904fbb21e6a3fac69b275395c5ffc106e48e2

depends_build	port:cmake
depends_lib	port:expat \
		port:freetype \
		port:hdf5-18 \
		port:jpeg \
		port:libxml2 \
		port:libogg port:libtheora \
		port:libpng \
		port:qt4-mac \
		port:tiff \
		port:zlib

# Some packages have problems with +universal, e.g. hdf5, python
universal_variant	no
# Taken from cmake portgroup
configure.ccache	no
configure.distcc	no
# Parallel build should speed up things
use_parallel_build	yes

# Need out-of-source-tree build
worksrcdir	${distname}
configure.dir	${workpath}/build
build.dir	${workpath}/build
destroot.dir	${workpath}/build

post-extract {
    file mkdir ${build.dir}
}

pre-build {
    ui_warn	"ParaView comes with its own netcdf, but may include system"
    ui_warn	"netcdf headers if present. If the build fails, you may need"
    ui_warn	"to deactivate ports netcdf netcdf-cxx until after the build."
}

# Should match the netcdf/hdf5 fartran compiler version
configure.compiler	macports-gcc-4.8

configure.env-append	\
	CMAKE_PREFIX_PATH=${prefix} \
	CMAKE_FRAMEWORK_PATH=${prefix}/Library/Frameworks \
	CMAKE_APPBUNDLE_PATH=${applications_dir}

configure.cmd	${prefix}/bin/cmake

# Do not change RPATH defaults; some progs may be run during the build.
# CMAKE_INSTALL_PREFIX is forced to ${build.dir}/CMakeFiles/__macos_install
# except for MACOSX_APP_INSTALL_PREFIX; unify this.
set install_prefix	${build.dir}/CMakeFiles/__macos_install
configure.pre_args	\
	-DCMAKE_INSTALL_PREFIX=${install_prefix} \
	-DMACOSX_APP_INSTALL_PREFIX=${install_prefix}/${applications_dir} \
	-DCMAKE_SYSTEM_PREFIX_PATH="${prefix}\;/usr" \
	-DCMAKE_FIND_FRAMEWORK=LAST \
	-DCMAKE_BUILD_TYPE=Release \
	-DCMAKE_COLOR_MAKEFILE=OFF \
	-DCMAKE_VERBOSE_MAKEFILE=OFF \
	-Wno-dev

configure.args	\
	-DBUILD_DOCUMENTATION=OFF \
	-DBUILD_EXAMPLES=OFF \
	-DBUILD_TESTING=OFF \
	-DPARAVIEW_ENABLE_FFMPEG=OFF \
	-DPARAVIEW_ENABLE_PYTHON=OFF \
	-DVTK_USE_SYSTEM_EXPAT=ON \
	-DVTK_USE_SYSTEM_FREETYPE=ON \
	-DVTK_USE_SYSTEM_GL2PS=OFF \
	-DVTK_USE_SYSTEM_HDF5=ON \
	-DVTK_USE_SYSTEM_JPEG=ON \
	-DVTK_USE_SYSTEM_LIBXML2=ON \
	-DVTK_USE_SYSTEM_OGGTHEORA=ON \
	-DVTK_USE_SYSTEM_PNG=ON \
	-DVTK_USE_SYSTEM_PROTOBUF=OFF \
	-DVTK_USE_SYSTEM_QTTESTING=OFF \
	-DVTK_USE_SYSTEM_TIFF=ON \
	-DVTK_USE_SYSTEM_VISITLIB=OFF \
	-DVTK_USE_SYSTEM_XDMF2=OFF \
	-DVTK_USE_SYSTEM_ZLIB=ON

configure.post_args	${worksrcpath}

# Since we install into a build subdir, no DESTDIR is necessary
destroot.destdir
post-destroot {
	# App bundle has been installed in the build tree, copy it over
	xinstall -d ${destroot}${applications_dir}
	file copy ${install_prefix}${applications_dir}/paraview.app \
		${destroot}${applications_dir}/ParaView.app
}

platform darwin {
    if {${os.major} < 10} {
	# SciberQuestToolKit plugin uses posix_memalign()
	# which is available only from Mac OS X 10.6 (darwin 10) onwards
	configure.args-append	-DPARAVIEW_BUILD_PLUGIN_SciberQuestToolKit=OFF
    }
}

variant doc description {build documentation (untested)} {
	configure.args-delete	-DBUILD_DOCUMENTATION=OFF
	configure.args-append	-DBUILD_DOCUMENTATION=ON
}

variant examples description {build examples (untested)} {
	configure.args-delete	-DBUILD_EXAMPLES=OFF
	configure.args-append	-DBUILD_EXAMPLES=ON
}

variant ffmpeg description {build FFMPEG encoder plugin} {
	depends_lib-append	port:ffmpeg
	configure.args-delete	-DPARAVIEW_ENABLE_FFMPEG=OFF
	configure.args-append	-DPARAVIEW_ENABLE_FFMPEG=ON
}

variant python27 description {enable scripting with python2.7} {
	depends_lib-append	port:python27 port:py27-numpy
	configure.args-delete	-DPARAVIEW_ENABLE_PYTHON=OFF
	configure.args-append	-DPARAVIEW_ENABLE_PYTHON=ON \
				-DPYTHON_EXECUTABLE=$prefix/bin/python2.7
}
